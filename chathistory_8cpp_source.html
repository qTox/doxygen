<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>qTox: src/model/chathistory.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">qTox
   &#160;<span id="projectnumber">Version: nightly | Commit: bc751c8e1cac455f9690654fcfe0f560d2d7dfdd</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_5dd65160827af56e6353642206b80129.html">model</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">chathistory.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="chathistory_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">    Copyright Â© 2019 by The qTox Project Contributors</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">    This file is part of qTox, a Qt-based graphical interface for Tox.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">    qTox is libre software: you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">    it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">    the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">    (at your option) any later version.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">    qTox is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">    GNU General Public License for more details.</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">    You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">    along with qTox.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="chathistory_8h.html">chathistory.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="settings_8h.html">src/persistence/settings.h</a>&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="chatform_8h.html">src/widget/form/chatform.h</a>&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span>{</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keywordtype">bool</span> needsLoadFromHistory(<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> idx, <span class="keyword">const</span> <a class="code" href="classSessionChatLog.html">SessionChatLog</a>&amp; sessionChatLog)</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;{</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="keywordflow">return</span> idx &lt; sessionChatLog.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>();</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;}</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160; </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> findFirstMessage(<span class="keyword">const</span> <a class="code" href="classSessionChatLog.html">SessionChatLog</a>&amp; sessionChatLog)</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;{</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keyword">auto</span> it = sessionChatLog.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>();</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keywordflow">while</span> (it &lt; sessionChatLog.<a class="code" href="classSessionChatLog.html#a0aba198b4987cc18478ca8bda8aba8f5">getNextIdx</a>()) {</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="keywordflow">if</span> (sessionChatLog.<a class="code" href="classSessionChatLog.html#a41d0356f1a51afa86316d9107592adab">at</a>(it).<a class="code" href="classChatLogItem.html#a8f24d7341e0ae0b21fee3f9e0bae9334">getContentType</a>() == <a class="code" href="classChatLogItem.html#a47d9e975dd844b586b423cd99319893ba78e731027d8fd50ed642340b7c9a63b3">ChatLogItem::ContentType::message</a>) {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;            <span class="keywordflow">return</span> it;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        it++;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    }</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(-1);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;}</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keywordtype">bool</span> handleActionPrefix(QString&amp; content)</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;{</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">// Unfortunately due to legacy reasons we have to continue</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">// inserting and parsing for ACTION_PREFIX in our messages even</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// though we have the ability to something more intelligent now</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">// that we aren&#39;t owned by chatform logic</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keyword">auto</span> isAction = content.startsWith(<a class="code" href="classChatForm.html#af0217fe33fb687e019f1c675a87a3931">ChatForm::ACTION_PREFIX</a>, Qt::CaseInsensitive);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordflow">if</span> (isAction) {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        content.remove(0, <a class="code" href="classChatForm.html#af0217fe33fb687e019f1c675a87a3931">ChatForm::ACTION_PREFIX</a>.<a class="code" href="namespaceFileTransferList.html#a349e50502ba7f13574a1822315a16c90af7bd60b75b29d79b660a2859395c1a24">size</a>());</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">return</span> isAction;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;}</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;} <span class="comment">// namespace</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="classChatHistory.html#a4af83d592f2eaee02a8316c3393a8d52">   73</a></span>&#160;<a class="code" href="classChatHistory.html#a4af83d592f2eaee02a8316c3393a8d52">ChatHistory::ChatHistory</a>(<a class="code" href="classFriend.html">Friend</a>&amp; f_, <a class="code" href="classHistory.html">History</a>* history_, <span class="keyword">const</span> <a class="code" href="classICoreIdHandler.html">ICoreIdHandler</a>&amp; coreIdHandler,</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                         <span class="keyword">const</span> <a class="code" href="classSettings.html">Settings</a>&amp; settings_, <a class="code" href="classIMessageDispatcher.html">IMessageDispatcher</a>&amp; messageDispatcher)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    : f(f_)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    , history(history_)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    , settings(settings_)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    , coreIdHandler(coreIdHandler)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    , sessionChatLog(getInitialChatLogIdx(), coreIdHandler)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;{</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    connect(&amp;messageDispatcher, &amp;<a class="code" href="classIMessageDispatcher.html#adb7aa138db9f744ef7a3217777309653">IMessageDispatcher::messageComplete</a>, <span class="keyword">this</span>,</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            &amp;<a class="code" href="classChatHistory.html#adf4f147d415a514283964e09ef4b1231">ChatHistory::onMessageComplete</a>);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    connect(&amp;messageDispatcher, &amp;<a class="code" href="classIMessageDispatcher.html#a1ce8d0da816495abb00561a22a65bab8">IMessageDispatcher::messageReceived</a>, <span class="keyword">this</span>,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            &amp;<a class="code" href="classChatHistory.html#addb5c44ae1d6e70549875bcb6636d69b">ChatHistory::onMessageReceived</a>);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    connect(&amp;messageDispatcher, &amp;<a class="code" href="classIMessageDispatcher.html#aa2019c77250918e5e634701b172187f9">IMessageDispatcher::messageBroken</a>, <span class="keyword">this</span>,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            &amp;<a class="code" href="classChatHistory.html#aa875c1b421ec3d24781b4ae95abfd159">ChatHistory::onMessageBroken</a>);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160; </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="comment">// Defer messageSent callback until we finish firing off all our unsent messages.</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="comment">// If it was connected all our unsent messages would be re-added ot history again</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <a class="code" href="classChatHistory.html#ae5e2e3220f00ee68a3394388d253e366">dispatchUnsentMessages</a>(messageDispatcher);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160; </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">// Now that we&#39;ve fired off our unsent messages we can connect the message</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    connect(&amp;messageDispatcher, &amp;<a class="code" href="classIMessageDispatcher.html#a4802ac590660667d9c4d73383544b38b">IMessageDispatcher::messageSent</a>, <span class="keyword">this</span>, &amp;<a class="code" href="classChatHistory.html#a8c1fc9d72feb0b27fcf44f8d4fc68036">ChatHistory::onMessageSent</a>);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// NOTE: this has to be done _after_ sending all sent messages since initial</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">// state of the message has to be marked according to our dispatch state</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    constexpr <span class="keyword">auto</span> defaultNumMessagesToLoad = 100;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keyword">auto</span> firstChatLogIdx = <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>().get() &lt; defaultNumMessagesToLoad</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                               ? <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(0)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                               : <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>() - defaultNumMessagesToLoad;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">loadHistoryIntoSessionChatLog</a>(firstChatLogIdx);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    }</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="comment">// We don&#39;t manage any of the item updates ourselves, we just forward along</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="comment">// the underlying sessionChatLog&#39;s updates</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    connect(&amp;<a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>, &amp;<a class="code" href="classIChatLog.html#af86b2f61da614a62e205008a5006d1be">IChatLog::itemUpdated</a>, <span class="keyword">this</span>, &amp;<a class="code" href="classIChatLog.html#af86b2f61da614a62e205008a5006d1be">IChatLog::itemUpdated</a>);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;}</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160; </div>
<div class="line"><a name="l00113"></a><span class="lineno"><a class="line" href="classChatHistory.html#a47c4d731377614a72939cf9aa6925ca9">  113</a></span>&#160;<span class="keyword">const</span> <a class="code" href="classChatLogItem.html">ChatLogItem</a>&amp; <a class="code" href="classChatHistory.html#a47c4d731377614a72939cf9aa6925ca9">ChatHistory::at</a>(<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> idx)<span class="keyword"> const</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <a class="code" href="classChatHistory.html#a344eb9def397254e0345c21e6bbf7ad4">ensureIdxInSessionChatLog</a>(idx);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a41d0356f1a51afa86316d9107592adab">at</a>(idx);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;}</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno"><a class="line" href="classChatHistory.html#ab2719a6a9cfa86eaa1907e4ee9d64674">  122</a></span>&#160;<a class="code" href="structSearchResult.html">SearchResult</a> <a class="code" href="classChatHistory.html#ab2719a6a9cfa86eaa1907e4ee9d64674">ChatHistory::searchForward</a>(<a class="code" href="structSearchPos.html">SearchPos</a> startIdx, <span class="keyword">const</span> QString&amp; phrase,</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                                        <span class="keyword">const</span> <a class="code" href="structParameterSearch.html">ParameterSearch</a>&amp; parameter)<span class="keyword"> const</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordflow">if</span> (startIdx.<a class="code" href="structSearchPos.html#a42bc44d531fe4da7fa9b631ca18a1ed9">logIdx</a> &gt;= <a class="code" href="classChatHistory.html#a7ea9c853c3fc44dc4b57e0e6068e143f">getNextIdx</a>()) {</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <a class="code" href="structSearchResult.html">SearchResult</a> res;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        res.<a class="code" href="structSearchResult.html#af45ce99ea066739300276269341cc906">found</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    }</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <a class="code" href="classChatHistory.html#a344eb9def397254e0345c21e6bbf7ad4">ensureIdxInSessionChatLog</a>(startIdx.<a class="code" href="structSearchPos.html#a42bc44d531fe4da7fa9b631ca18a1ed9">logIdx</a>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    }</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a27a7596ee194fd68c89d34c07d8d9592">searchForward</a>(startIdx, phrase, parameter);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno"><a class="line" href="classChatHistory.html#ab3ea46732b21c61aaaaf7147ec2e1d12">  138</a></span>&#160;<a class="code" href="structSearchResult.html">SearchResult</a> <a class="code" href="classChatHistory.html#ab3ea46732b21c61aaaaf7147ec2e1d12">ChatHistory::searchBackward</a>(<a class="code" href="structSearchPos.html">SearchPos</a> startIdx, <span class="keyword">const</span> QString&amp; phrase,</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                                         <span class="keyword">const</span> <a class="code" href="structParameterSearch.html">ParameterSearch</a>&amp; parameter)<span class="keyword"> const</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keyword">auto</span> res = <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a9cf332e8a5ab6afe56f25e020aff0069">searchBackward</a>(startIdx, phrase, parameter);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">if</span> (res.found || !<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    }</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keyword">auto</span> earliestMessage = findFirstMessage(<a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keyword">auto</span> earliestMessageDate =</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        (earliestMessage == <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(-1))</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            ? QDateTime::currentDateTime()</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            : <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a41d0356f1a51afa86316d9107592adab">at</a>(earliestMessage).<a class="code" href="classChatLogItem.html#a3920bf552f66ac72be4b6ec8fe7947cd">getContentAsMessage</a>().<a class="code" href="structChatLogMessage.html#ab4a27761e501b10860a62bc05d7f2b59">message</a>.<a class="code" href="structMessage.html#a404a35c5ab63d17c5f83e40487751fe2">timestamp</a>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="comment">// Roundabout way of getting the first idx but I don&#39;t want to have to</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// deal with re-implementing so we&#39;ll just piece what we want together...</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="comment">// If the double disk access is real bad we can optimize this by adding</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="comment">// another function to history</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keyword">auto</span> dateWherePhraseFound =</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#ad104cfe24475f8a6ee23641d8c8fe8ac">getDateWhereFindPhrase</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(), earliestMessageDate, phrase,</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                                        parameter);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keyword">auto</span> loadIdx = <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a889a688372db3fe48bdb1dc37e8755c2">getNumMessagesForFriendBeforeDate</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(), dateWherePhraseFound);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <a class="code" href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">loadHistoryIntoSessionChatLog</a>(<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(loadIdx));</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// Reset search pos to the message we just loaded to avoid a double search</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    startIdx.<a class="code" href="structSearchPos.html#a42bc44d531fe4da7fa9b631ca18a1ed9">logIdx</a> = <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(loadIdx);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    startIdx.<a class="code" href="structSearchPos.html#afe2cc6801fe8267916714079c4d1ff25">numMatches</a> = 0;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a9cf332e8a5ab6afe56f25e020aff0069">searchBackward</a>(startIdx, phrase, parameter);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;}</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno"><a class="line" href="classChatHistory.html#abc6dbab246d6fa064d84c1bae97dec25">  172</a></span>&#160;<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> <a class="code" href="classChatHistory.html#abc6dbab246d6fa064d84c1bae97dec25">ChatHistory::getFirstIdx</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(0);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>();</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno"><a class="line" href="classChatHistory.html#a7ea9c853c3fc44dc4b57e0e6068e143f">  181</a></span>&#160;<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> <a class="code" href="classChatHistory.html#a7ea9c853c3fc44dc4b57e0e6068e143f">ChatHistory::getNextIdx</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a0aba198b4987cc18478ca8bda8aba8f5">getNextIdx</a>();</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;}</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="classChatHistory.html#a7281d4a0fe8b2cbb4c7e973cf6550491">  186</a></span>&#160;std::vector&lt;IChatLog::DateChatLogIdxPair&gt; <a class="code" href="classChatHistory.html#a7281d4a0fe8b2cbb4c7e973cf6550491">ChatHistory::getDateIdxs</a>(<span class="keyword">const</span> QDate&amp; startDate,</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                                                                   <span class="keywordtype">size_t</span> maxDates)<span class="keyword"> const</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keyword">auto</span> counts = <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a358d34068f7daba96c510e3236a4e004">getNumMessagesForFriendBeforeDateBoundaries</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(),</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                                                                           startDate, maxDates);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        std::vector&lt;IChatLog::DateChatLogIdxPair&gt; ret;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        std::transform(counts.begin(), counts.end(), std::back_inserter(ret),</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                       [&amp;](<span class="keyword">const</span> <a class="code" href="structHistory_1_1DateIdx.html">History::DateIdx</a>&amp; historyDateIdx) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                           DateChatLogIdxPair pair;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                           pair.date = historyDateIdx.date;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                           pair.idx.get() = historyDateIdx.numMessagesIn;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                           return pair;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                       });</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="comment">// Do not re-search in the session chat log. If we have history the query to the history should have been sufficient</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a9be62632a62081c25f2a794087830e54">getDateIdxs</a>(startDate, maxDates);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    }</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;}</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="classChatHistory.html#a3fb366a4aa06e95f9fa72d592076934a">  209</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a3fb366a4aa06e95f9fa72d592076934a">ChatHistory::addSystemMessage</a>(<span class="keyword">const</span> <a class="code" href="structSystemMessage.html">SystemMessage</a>&amp; message)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;{</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a211bf5d2ffa4c1657b4c5f37fcebf510">addNewSystemMessage</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(), <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#ac54787b413212bf6ff6dc7afe8aba011">addSystemMessage</a>(<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;}</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno"><a class="line" href="classChatHistory.html#a46049bd99919563e0b5dd16fe90f7d74">  219</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a46049bd99919563e0b5dd16fe90f7d74">ChatHistory::onFileUpdated</a>(<span class="keyword">const</span> <a class="code" href="classToxPk.html">ToxPk</a>&amp; sender, <span class="keyword">const</span> <a class="code" href="structToxFile.html">ToxFile</a>&amp; file)</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;{</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordflow">switch</span> (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.status) {</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a0bf5a3ac9b920a4cd3c591b5f20ecbdc">ToxFile::INITIALIZING</a>: {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <span class="keyword">auto</span> selfPk = <a class="code" href="classChatHistory.html#ace6cb8a2aa79064f748153a67820904a">coreIdHandler</a>.<a class="code" href="classICoreIdHandler.html#a15380c37fd91dabf3399783f6361a5fd">getSelfPublicKey</a>();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            QString username(selfPk == sender ? <a class="code" href="classChatHistory.html#ace6cb8a2aa79064f748153a67820904a">coreIdHandler</a>.<a class="code" href="classICoreIdHandler.html#a54096b98ab4c67bbb7fc228a4ea8fefa">getUsername</a>() : <a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#a4e5ab2a6eb7e7ea04d2b01d73677a280">getDisplayedName</a>());</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            <span class="comment">// Note: There is some implcit coupling between history and the current</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            <span class="comment">// chat log. Both rely on generating a new id based on the state of</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="comment">// initializing. If this is changed in the session chat log we&#39;ll end up</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="comment">// with a different order when loading from history</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a45e92a551ba16cee4704458c16237a97">addNewFileMessage</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(), <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.resumeFileId, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.fileName,</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                                       <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.filePath, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.progress.getFileSize(), sender,</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                                       QDateTime::currentDateTime(), username);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        }</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1aaf48ada90ef17e0c187e8f44e6cba2d6">ToxFile::CANCELED</a>:</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1ac04d6ce3c9d38de326215f45299a1375">ToxFile::FINISHED</a>:</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a9e63b6410fb242e242e59efbb93c0f58">ToxFile::BROKEN</a>: {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">bool</span> isSuccess = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.status == <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1ac04d6ce3c9d38de326215f45299a1375">ToxFile::FINISHED</a>;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a74104ef2bbc6d9d387f675aadd8b7fa0">setFileFinished</a>(<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.resumeFileId, isSuccess, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.filePath,</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                     <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>.hashGenerator-&gt;result());</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1af0d36f6445e3334cb7be476f5bd815bf">ToxFile::PAUSED</a>:</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a970de2386775b7c5ee03f082f118ced1">ToxFile::TRANSMITTING</a>:</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        }</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a5d3f25f92f514a87542490a5e0b6cd82">onFileUpdated</a>(sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;}</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160; </div>
<div class="line"><a name="l00254"></a><span class="lineno"><a class="line" href="classChatHistory.html#a2a7accf97c9238b9c45c7949fda929b1">  254</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a2a7accf97c9238b9c45c7949fda929b1">ChatHistory::onFileTransferRemotePausedUnpaused</a>(<span class="keyword">const</span> <a class="code" href="classToxPk.html">ToxPk</a>&amp; sender, <span class="keyword">const</span> <a class="code" href="structToxFile.html">ToxFile</a>&amp; file,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                                     <span class="keywordtype">bool</span> paused)</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;{</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a1fecc026256c1c85fe70413717b78614">onFileTransferRemotePausedUnpaused</a>(sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>, paused);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;}</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; </div>
<div class="line"><a name="l00260"></a><span class="lineno"><a class="line" href="classChatHistory.html#abddd05bb13f8ae19010a847aba7581a3">  260</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#abddd05bb13f8ae19010a847aba7581a3">ChatHistory::onFileTransferBrokenUnbroken</a>(<span class="keyword">const</span> <a class="code" href="classToxPk.html">ToxPk</a>&amp; sender, <span class="keyword">const</span> <a class="code" href="structToxFile.html">ToxFile</a>&amp; file, <span class="keywordtype">bool</span> broken)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;{</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a26621d3829ef2381a2d253d78995f6b1">onFileTransferBrokenUnbroken</a>(sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>, <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ea54ddc3c7d064822eed932015d8740336">broken</a>);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;}</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160; </div>
<div class="line"><a name="l00265"></a><span class="lineno"><a class="line" href="classChatHistory.html#addb5c44ae1d6e70549875bcb6636d69b">  265</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#addb5c44ae1d6e70549875bcb6636d69b">ChatHistory::onMessageReceived</a>(<span class="keyword">const</span> <a class="code" href="classToxPk.html">ToxPk</a>&amp; sender, <span class="keyword">const</span> <a class="code" href="structMessage.html">Message</a>&amp; message)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;{</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keyword">auto</span> friendPk = <a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>();</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="keyword">auto</span> displayName = <a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#a4e5ab2a6eb7e7ea04d2b01d73677a280">getDisplayedName</a>();</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keyword">auto</span> content = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.isAction) {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            content = <a class="code" href="classChatForm.html#af0217fe33fb687e019f1c675a87a3931">ChatForm::ACTION_PREFIX</a> + content;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#abcce3c0e31955b6bf77b8d96a62e5b29">addNewMessage</a>(friendPk, content, friendPk, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.timestamp, <span class="keyword">true</span>, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.extensionSet, displayName);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a91e922f07ec81480eff8e43b839d7617">onMessageReceived</a>(sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;}</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno"><a class="line" href="classChatHistory.html#a8c1fc9d72feb0b27fcf44f8d4fc68036">  281</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a8c1fc9d72feb0b27fcf44f8d4fc68036">ChatHistory::onMessageSent</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> <span class="keywordtype">id</span>, <span class="keyword">const</span> <a class="code" href="structMessage.html">Message</a>&amp; message)</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;{</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keyword">auto</span> selfPk = <a class="code" href="classChatHistory.html#ace6cb8a2aa79064f748153a67820904a">coreIdHandler</a>.<a class="code" href="classICoreIdHandler.html#a15380c37fd91dabf3399783f6361a5fd">getSelfPublicKey</a>();</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="keyword">auto</span> friendPk = <a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>();</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="keyword">auto</span> content = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.isAction) {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            content = <a class="code" href="classChatForm.html#af0217fe33fb687e019f1c675a87a3931">ChatForm::ACTION_PREFIX</a> + content;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160; </div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keyword">auto</span> username = <a class="code" href="classChatHistory.html#ace6cb8a2aa79064f748153a67820904a">coreIdHandler</a>.<a class="code" href="classICoreIdHandler.html#a54096b98ab4c67bbb7fc228a4ea8fefa">getUsername</a>();</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160; </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="keyword">auto</span> onInsertion = [<span class="keyword">this</span>, id](<a class="code" href="rawdatabase_8h.html#abbeb84b4f2e88670ea185408462d094c">RowId</a> historyId) { <a class="code" href="classChatHistory.html#a750f5d39ddd30b1f2a8c28dc0947d69f">handleDispatchedMessage</a>(<span class="keywordtype">id</span>, historyId); };</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#abcce3c0e31955b6bf77b8d96a62e5b29">addNewMessage</a>(friendPk, content, selfPk, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.timestamp, <span class="keyword">false</span>, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.extensionSet, username,</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                               onInsertion);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    }</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#ab863726828d5cc1c0b756f0950ad67ef">onMessageSent</a>(<span class="keywordtype">id</span>, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;}</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160; </div>
<div class="line"><a name="l00303"></a><span class="lineno"><a class="line" href="classChatHistory.html#adf4f147d415a514283964e09ef4b1231">  303</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#adf4f147d415a514283964e09ef4b1231">ChatHistory::onMessageComplete</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> <span class="keywordtype">id</span>)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;{</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        <a class="code" href="classChatHistory.html#a190a6ea7cca8337ec5f345a681de4026">completeMessage</a>(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#aaafbdf70e7db74e8ed61496667e16a13">onMessageComplete</a>(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;}</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160; </div>
<div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="classChatHistory.html#aa875c1b421ec3d24781b4ae95abfd159">  312</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#aa875c1b421ec3d24781b4ae95abfd159">ChatHistory::onMessageBroken</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> <span class="keywordtype">id</span>, <a class="code" href="brokenmessagereason_8h.html#a5aeb89765ee85523ed7aba8a393f0082">BrokenMessageReason</a> reason)</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;{</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <a class="code" href="classChatHistory.html#a94791b3d1407d966e4a649838e07bc36">breakMessage</a>(<span class="keywordtype">id</span>, reason);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a9ecefb888407250904177a8a2dd0e9e3">onMessageBroken</a>(<span class="keywordtype">id</span>, reason);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;}</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno"><a class="line" href="classChatHistory.html#a344eb9def397254e0345c21e6bbf7ad4">  328</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a344eb9def397254e0345c21e6bbf7ad4">ChatHistory::ensureIdxInSessionChatLog</a>(<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> idx)<span class="keyword"> const</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">if</span> (needsLoadFromHistory(idx, <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>)) {</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <a class="code" href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">loadHistoryIntoSessionChatLog</a>(idx);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    }</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;}</div>
<div class="line"><a name="l00344"></a><span class="lineno"><a class="line" href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">  344</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">ChatHistory::loadHistoryIntoSessionChatLog</a>(<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> start)<span class="keyword"> const</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="keywordflow">if</span> (!needsLoadFromHistory(start, <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>)) {</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160; </div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keyword">auto</span> end = <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">getFirstIdx</a>();</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">// We know that both history and us have a start index of 0 so the type</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">// conversion should be safe</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    assert(<a class="code" href="classChatHistory.html#abc6dbab246d6fa064d84c1bae97dec25">getFirstIdx</a>() == <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(0));</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keyword">auto</span> messages = <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a51b715e3544228018a5a035652ae56de">getMessagesForFriend</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>(), start.get(), end.get());</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    assert(messages.size() == <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(end.get() - start.get()));</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> nextIdx = start;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160; </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a> : messages) {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="comment">// Note that message.id is _not_ a valid conversion here since it is a</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        <span class="comment">// global id not a per-chat id like the ChatLogIdx</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="keyword">auto</span> currentIdx = nextIdx++;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="keywordflow">switch</span> (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.getType()) {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">HistMessageContentType::file</a>: {</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            <span class="keyword">auto</span> sender = <a class="code" href="classToxPk.html">ToxPk</a>(<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.sender);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> date = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.timestamp;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a> = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.asFile();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> chatLogFile = <a class="code" href="structChatLogFile.html">ChatLogFile</a>{date, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">file</a>};</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a274431e7d5d7b3899403f5bcc6ab3ffe">insertFileAtIdx</a>(currentIdx, sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.dispName, chatLogFile);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        }</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">HistMessageContentType::message</a>: {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keyword">auto</span> sender = <a class="code" href="classToxPk.html">ToxPk</a>(<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.sender);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keyword">auto</span> messageContent = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.asMessage();</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            <span class="keyword">auto</span> isAction = handleActionPrefix(messageContent);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160; </div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            <span class="comment">// It&#39;s okay to skip the message processor here. The processor is</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="comment">// meant to convert between boundaries of our internal</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <span class="comment">// representation. We already had to go through the processor before</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <span class="comment">// we hit IMessageDispatcher&#39;s signals which history listens for.</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            <span class="comment">// Items added to history have already been sent so we know they already</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            <span class="comment">// reflect what was sent/received.</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="keyword">auto</span> processedMessage = <a class="code" href="structMessage.html">Message</a>{isAction, messageContent, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.timestamp};</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="keyword">auto</span> dispatchedMessageIt =</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                std::find_if(<a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.begin(), <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.end(),</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                             [&amp;](<a class="code" href="rawdatabase_8h.html#abbeb84b4f2e88670ea185408462d094c">RowId</a> dispatchedId) { return dispatchedId == message.id; });</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160; </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            assert((<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.state != <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ea7c6c2e5d48ab37a007cbf70d3ea25fa4">MessageState::pending</a> &amp;&amp; dispatchedMessageIt == <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.end()) ||</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                   (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.state == <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ea7c6c2e5d48ab37a007cbf70d3ea25fa4">MessageState::pending</a> &amp;&amp; dispatchedMessageIt != <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.end()));</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160; </div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            <span class="keyword">auto</span> chatLogMessage = <a class="code" href="structChatLogMessage.html">ChatLogMessage</a>{<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.state, processedMessage};</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            <span class="keywordflow">switch</span> (<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.state) {</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ead9a22d7a8178d5b42a8750123cbfe5b1">MessageState::complete</a>:</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#ad759dd3e126305734a0ce86927752422">insertCompleteMessageAtIdx</a>(currentIdx, sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.dispName,</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                                                              chatLogMessage);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ea7c6c2e5d48ab37a007cbf70d3ea25fa4">MessageState::pending</a>:</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#adffa9a880387ea74bdacf7a4b176beb0">insertIncompleteMessageAtIdx</a>(currentIdx, sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.dispName,</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                                                                chatLogMessage, dispatchedMessageIt.key());</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="history_8h.html#ad41836a9943219d559e6adece196749ea54ddc3c7d064822eed932015d8740336">MessageState::broken</a>:</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                    <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#a7925da808543a5228a662b654ee6c3fd">insertBrokenMessageAtIdx</a>(currentIdx, sender, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.dispName,</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                                                            chatLogMessage);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        }</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da54b53072540eeeb8f8e9343e71f28176">HistMessageContentType::system</a>: {</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; systemMessage = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.asSystemMessage();</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            <a class="code" href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">sessionChatLog</a>.<a class="code" href="classSessionChatLog.html#ac8c375d7556639b3dce5eca75cce9018">insertSystemMessageAtIdx</a>(currentIdx, systemMessage);</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        }</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        }</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    assert(nextIdx == end);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;}</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00426"></a><span class="lineno"><a class="line" href="classChatHistory.html#ae5e2e3220f00ee68a3394388d253e366">  426</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#ae5e2e3220f00ee68a3394388d253e366">ChatHistory::dispatchUnsentMessages</a>(<a class="code" href="classIMessageDispatcher.html">IMessageDispatcher</a>&amp; messageDispatcher)</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;{</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keyword">auto</span> unsentMessages = <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a3b82aa28959279e829dcd4efb4a27fa8">getUndeliveredMessagesForFriend</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>());</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keyword">auto</span> requiredExtensions = std::accumulate(</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        unsentMessages.begin(), unsentMessages.end(),</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <a class="code" href="extension_8h.html#a7938c358297aa9db8ac6f400a81681aa">ExtensionSet</a>(), [] (<span class="keyword">const</span> <a class="code" href="extension_8h.html#a7938c358297aa9db8ac6f400a81681aa">ExtensionSet</a>&amp; a, <span class="keyword">const</span> <a class="code" href="structHistory_1_1HistMessage.html">History::HistMessage</a>&amp; b) {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            <span class="keywordflow">return</span> a | b.<a class="code" href="structHistory_1_1HistMessage.html#a7fe2da7726895af7865e5d4fe24c8337">extensionSet</a>;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        });</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160; </div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a> : unsentMessages) {</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="comment">// We should only store messages as unsent, if this changes in the</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="comment">// future we need to extend this logic</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        assert(<a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.getType() == <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">HistMessageContentType::message</a>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keyword">auto</span> messageContent = <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.content.asMessage();</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keyword">auto</span> isAction = handleActionPrefix(messageContent);</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160; </div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="comment">// NOTE: timestamp will be generated in messageDispatcher but we haven&#39;t</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="comment">// hooked up our history callback so it will not be shown in our chatlog</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="comment">// with the new timestamp. This is intentional as everywhere else we use</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="comment">// attempted send time (which is whenever the it was initially inserted</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="comment">// into history</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keyword">auto</span> dispatchId = requiredExtensions.none()</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            <span class="comment">// We should only send a single message, but in the odd case where we end</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            <span class="comment">// up having to split more than when we added the message to history we&#39;ll</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="comment">// just associate the last dispatched id with the history message</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            ? messageDispatcher.<a class="code" href="classIMessageDispatcher.html#a717366726b6aeb6455a34554a6055aac">sendMessage</a>(isAction, messageContent).second</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            : messageDispatcher.<a class="code" href="classIMessageDispatcher.html#a979682abd2375761cad6dfd4efca5693">sendExtendedMessage</a>(messageContent, requiredExtensions).second;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160; </div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <a class="code" href="classChatHistory.html#a750f5d39ddd30b1f2a8c28dc0947d69f">handleDispatchedMessage</a>(dispatchId, <a class="code" href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">message</a>.id);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160; </div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="comment">// We don&#39;t add the messages to the underlying chatlog since</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="comment">// 1. We don&#39;t even know the ChatLogIdx of this message</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <span class="comment">// 2. We only want to display the latest N messages on boot by default,</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="comment">//    even if there are more than N messages that haven&#39;t been sent</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    }</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;}</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno"><a class="line" href="classChatHistory.html#a750f5d39ddd30b1f2a8c28dc0947d69f">  465</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a750f5d39ddd30b1f2a8c28dc0947d69f">ChatHistory::handleDispatchedMessage</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> dispatchId, <a class="code" href="rawdatabase_8h.html#abbeb84b4f2e88670ea185408462d094c">RowId</a> historyId)</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;{</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="keyword">auto</span> completedMessageIt = <a class="code" href="classChatHistory.html#a091602a866650a2fa999eda6bacca2ad">completedMessages</a>.find(dispatchId);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keyword">auto</span> brokenMessageIt = <a class="code" href="classChatHistory.html#ad04eb691ef9e122b4ebc8a1a74064ed1">brokenMessages</a>.find(dispatchId);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> isCompleted = completedMessageIt != <a class="code" href="classChatHistory.html#a091602a866650a2fa999eda6bacca2ad">completedMessages</a>.end();</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> isBroken = brokenMessageIt != <a class="code" href="classChatHistory.html#ad04eb691ef9e122b4ebc8a1a74064ed1">brokenMessages</a>.end();</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    assert(!(isCompleted &amp;&amp; isBroken));</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">if</span> (isCompleted) {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a08022c9c5a58ddd0ccc7421042ba1e0a">markAsDelivered</a>(historyId);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <a class="code" href="classChatHistory.html#a091602a866650a2fa999eda6bacca2ad">completedMessages</a>.erase(completedMessageIt);</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isBroken) {</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#af6a540f04cee58bf32f6ac7e3d0dc418">markAsBroken</a>(historyId, brokenMessageIt.value());</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <a class="code" href="classChatHistory.html#ad04eb691ef9e122b4ebc8a1a74064ed1">brokenMessages</a>.erase(brokenMessageIt);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.insert(dispatchId, historyId);</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    }</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;}</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno"><a class="line" href="classChatHistory.html#a190a6ea7cca8337ec5f345a681de4026">  485</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a190a6ea7cca8337ec5f345a681de4026">ChatHistory::completeMessage</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> <span class="keywordtype">id</span>)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;{</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keyword">auto</span> dispatchedMessageIt = <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.find(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="keywordflow">if</span> (dispatchedMessageIt == <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.end()) {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <a class="code" href="classChatHistory.html#a091602a866650a2fa999eda6bacca2ad">completedMessages</a>.insert(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#a08022c9c5a58ddd0ccc7421042ba1e0a">markAsDelivered</a>(*dispatchedMessageIt);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.erase(dispatchedMessageIt);</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    }</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;}</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno"><a class="line" href="classChatHistory.html#a94791b3d1407d966e4a649838e07bc36">  497</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChatHistory.html#a94791b3d1407d966e4a649838e07bc36">ChatHistory::breakMessage</a>(<a class="code" href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a> <span class="keywordtype">id</span>, <a class="code" href="brokenmessagereason_8h.html#a5aeb89765ee85523ed7aba8a393f0082">BrokenMessageReason</a> reason)</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;{</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keyword">auto</span> dispatchedMessageIt = <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.find(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> (dispatchedMessageIt == <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.end()) {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <a class="code" href="classChatHistory.html#ad04eb691ef9e122b4ebc8a1a74064ed1">brokenMessages</a>.insert(<span class="keywordtype">id</span>, reason);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#af6a540f04cee58bf32f6ac7e3d0dc418">markAsBroken</a>(*dispatchedMessageIt, reason);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <a class="code" href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">dispatchedMessageRowIdMap</a>.erase(dispatchedMessageIt);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    }</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;}</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160; </div>
<div class="line"><a name="l00509"></a><span class="lineno"><a class="line" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">  509</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">ChatHistory::canUseHistory</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a> &amp;&amp; <a class="code" href="classChatHistory.html#a20c9d56f2fddd8d12c6d7d98e0d4e437">settings</a>.<a class="code" href="classSettings.html#a20043d9e2168266b84dd45e90a932a6a">getEnableLogging</a>();</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;}</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="classChatHistory.html#a5e98010471983b9890f7ef673b1e1bef">  521</a></span>&#160;<a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a> <a class="code" href="classChatHistory.html#a5e98010471983b9890f7ef673b1e1bef">ChatHistory::getInitialChatLogIdx</a>()<span class="keyword"> const</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">canUseHistory</a>()) {</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(<a class="code" href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">history</a>-&gt;<a class="code" href="classHistory.html#ac44641454765cf9ce2c71ed1e17adccf">getNumMessagesForFriend</a>(<a class="code" href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">f</a>.<a class="code" href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">getPublicKey</a>()));</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    }</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a>(0);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="aclassChatHistory_html_a385c0861dc9410fcf18684d8fe8fc019"><div class="ttname"><a href="classChatHistory.html#a385c0861dc9410fcf18684d8fe8fc019">ChatHistory::loadHistoryIntoSessionChatLog</a></div><div class="ttdeci">void loadHistoryIntoSessionChatLog(ChatLogIdx start) const</div><div class="ttdoc">Unconditionally loads the given index and all future messages that are not in the session chat log in...</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00344">chathistory.cpp:344</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_af3155efcac617b8e031177d281438c41"><div class="ttname"><a href="classSessionChatLog.html#af3155efcac617b8e031177d281438c41">SessionChatLog::getFirstIdx</a></div><div class="ttdeci">ChatLogIdx getFirstIdx() const override</div><div class="ttdoc">The underlying chat log instance may not want to start at 0.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00280">sessionchatlog.cpp:280</a></div></div>
<div class="ttc" id="aclassSettings_html"><div class="ttname"><a href="classSettings.html">Settings</a></div><div class="ttdef"><b>Definition:</b> <a href="settings_8h_source.html#l00051">settings.h:51</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a9ecefb888407250904177a8a2dd0e9e3"><div class="ttname"><a href="classSessionChatLog.html#a9ecefb888407250904177a8a2dd0e9e3">SessionChatLog::onMessageBroken</a></div><div class="ttdeci">void onMessageBroken(DispatchedMessageId id, BrokenMessageReason reason)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00439">sessionchatlog.cpp:439</a></div></div>
<div class="ttc" id="aclassHistory_html_a74104ef2bbc6d9d387f675aadd8b7fa0"><div class="ttname"><a href="classHistory.html#a74104ef2bbc6d9d387f675aadd8b7fa0">History::setFileFinished</a></div><div class="ttdeci">void setFileFinished(const QString &amp;fileId, bool success, const QString &amp;filePath, const QByteArray &amp;fileHash)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l00989">history.cpp:989</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a0ecb3b6dc8c63bf704358d40b9177c5e"><div class="ttname"><a href="classChatHistory.html#a0ecb3b6dc8c63bf704358d40b9177c5e">ChatHistory::history</a></div><div class="ttdeci">History * history</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00070">chathistory.h:70</a></div></div>
<div class="ttc" id="aclassChatLogItem_html"><div class="ttname"><a href="classChatLogItem.html">ChatLogItem</a></div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8h_source.html#l00042">chatlogitem.h:42</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a7ea9c853c3fc44dc4b57e0e6068e143f"><div class="ttname"><a href="classChatHistory.html#a7ea9c853c3fc44dc4b57e0e6068e143f">ChatHistory::getNextIdx</a></div><div class="ttdeci">ChatLogIdx getNextIdx() const override</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00181">chathistory.cpp:181</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a5d3f25f92f514a87542490a5e0b6cd82"><div class="ttname"><a href="classSessionChatLog.html#a5d3f25f92f514a87542490a5e0b6cd82">SessionChatLog::onFileUpdated</a></div><div class="ttdeci">void onFileUpdated(const ToxPk &amp;sender, const ToxFile &amp;file)</div><div class="ttdoc">Updates file state in the chatlog.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00467">sessionchatlog.cpp:467</a></div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1a9e63b6410fb242e242e59efbb93c0f58"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a9e63b6410fb242e242e59efbb93c0f58">ToxFile::BROKEN</a></div><div class="ttdeci">@ BROKEN</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00041">toxfile.h:41</a></div></div>
<div class="ttc" id="asettings_8h_html"><div class="ttname"><a href="settings_8h.html">settings.h</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a9be62632a62081c25f2a794087830e54"><div class="ttname"><a href="classSessionChatLog.html#a9be62632a62081c25f2a794087830e54">SessionChatLog::getDateIdxs</a></div><div class="ttdeci">std::vector&lt; DateChatLogIdxPair &gt; getDateIdxs(const QDate &amp;startDate, size_t maxDates) const override</div><div class="ttdoc">Gets indexes for each new date starting at startDate.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00294">sessionchatlog.cpp:294</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a8c1fc9d72feb0b27fcf44f8d4fc68036"><div class="ttname"><a href="classChatHistory.html#a8c1fc9d72feb0b27fcf44f8d4fc68036">ChatHistory::onMessageSent</a></div><div class="ttdeci">void onMessageSent(DispatchedMessageId id, const Message &amp;message)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00281">chathistory.cpp:281</a></div></div>
<div class="ttc" id="aclassICoreIdHandler_html_a54096b98ab4c67bbb7fc228a4ea8fefa"><div class="ttname"><a href="classICoreIdHandler.html#a54096b98ab4c67bbb7fc228a4ea8fefa">ICoreIdHandler::getUsername</a></div><div class="ttdeci">virtual QString getUsername() const =0</div></div>
<div class="ttc" id="aclassChatHistory_html_a2a7accf97c9238b9c45c7949fda929b1"><div class="ttname"><a href="classChatHistory.html#a2a7accf97c9238b9c45c7949fda929b1">ChatHistory::onFileTransferRemotePausedUnpaused</a></div><div class="ttdeci">void onFileTransferRemotePausedUnpaused(const ToxPk &amp;sender, const ToxFile &amp;file, bool paused)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00254">chathistory.cpp:254</a></div></div>
<div class="ttc" id="aclassHistory_html_af6a540f04cee58bf32f6ac7e3d0dc418"><div class="ttname"><a href="classHistory.html#af6a540f04cee58bf32f6ac7e3d0dc418">History::markAsBroken</a></div><div class="ttdeci">void markAsBroken(RowId messageId, BrokenMessageReason reason)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01402">history.cpp:1402</a></div></div>
<div class="ttc" id="astructParameterSearch_html"><div class="ttname"><a href="structParameterSearch.html">ParameterSearch</a></div><div class="ttdef"><b>Definition:</b> <a href="searchtypes_8h_source.html#l00047">searchtypes.h:47</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_ab863726828d5cc1c0b756f0950ad67ef"><div class="ttname"><a href="classSessionChatLog.html#ab863726828d5cc1c0b756f0950ad67ef">SessionChatLog::onMessageSent</a></div><div class="ttdeci">void onMessageSent(DispatchedMessageId id, const Message &amp;message)</div><div class="ttdoc">Inserts message data into the chatlog buffer.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00397">sessionchatlog.cpp:397</a></div></div>
<div class="ttc" id="arawdatabase_8h_html_abbeb84b4f2e88670ea185408462d094c"><div class="ttname"><a href="rawdatabase_8h.html#abbeb84b4f2e88670ea185408462d094c">RowId</a></div><div class="ttdeci">NamedType&lt; int64_t, struct RowIdTag, Orderable &gt; RowId</div><div class="ttdef"><b>Definition:</b> <a href="rawdatabase_8h_source.html#l00049">rawdatabase.h:49</a></div></div>
<div class="ttc" id="aclassChatHistory_html_abc6dbab246d6fa064d84c1bae97dec25"><div class="ttname"><a href="classChatHistory.html#abc6dbab246d6fa064d84c1bae97dec25">ChatHistory::getFirstIdx</a></div><div class="ttdeci">ChatLogIdx getFirstIdx() const override</div><div class="ttdoc">The underlying chat log instance may not want to start at 0.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00172">chathistory.cpp:172</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a47c4d731377614a72939cf9aa6925ca9"><div class="ttname"><a href="classChatHistory.html#a47c4d731377614a72939cf9aa6925ca9">ChatHistory::at</a></div><div class="ttdeci">const ChatLogItem &amp; at(ChatLogIdx idx) const override</div><div class="ttdoc">Returns reference to item at idx.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00113">chathistory.cpp:113</a></div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1a970de2386775b7c5ee03f082f118ced1"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a970de2386775b7c5ee03f082f118ced1">ToxFile::TRANSMITTING</a></div><div class="ttdeci">@ TRANSMITTING</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00040">toxfile.h:40</a></div></div>
<div class="ttc" id="aclassChatLogItem_html_a47d9e975dd844b586b423cd99319893ba78e731027d8fd50ed642340b7c9a63b3"><div class="ttname"><a href="classChatLogItem.html#a47d9e975dd844b586b423cd99319893ba78e731027d8fd50ed642340b7c9a63b3">ChatLogItem::ContentType::message</a></div><div class="ttdeci">@ message</div></div>
<div class="ttc" id="ahistory_8h_html_a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac"><div class="ttname"><a href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da8c7dd922ad47494fc02c388e12c00eac">HistMessageContentType::file</a></div><div class="ttdeci">@ file</div></div>
<div class="ttc" id="achathistory_8h_html"><div class="ttname"><a href="chathistory_8h.html">chathistory.h</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_a717366726b6aeb6455a34554a6055aac"><div class="ttname"><a href="classIMessageDispatcher.html#a717366726b6aeb6455a34554a6055aac">IMessageDispatcher::sendMessage</a></div><div class="ttdeci">virtual std::pair&lt; DispatchedMessageId, DispatchedMessageId &gt; sendMessage(bool isAction, const QString &amp;content)=0</div><div class="ttdoc">Sends message to associated chat.</div></div>
<div class="ttc" id="aclassSessionChatLog_html_a9cf332e8a5ab6afe56f25e020aff0069"><div class="ttname"><a href="classSessionChatLog.html#a9cf332e8a5ab6afe56f25e020aff0069">SessionChatLog::searchBackward</a></div><div class="ttdeci">SearchResult searchBackward(SearchPos startIdx, const QString &amp;phrase, const ParameterSearch &amp;parameter) const override</div><div class="ttdoc">searches backwards through the chat log until phrase is found according to parameter</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00213">sessionchatlog.cpp:213</a></div></div>
<div class="ttc" id="astructSystemMessage_html"><div class="ttname"><a href="structSystemMessage.html">SystemMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="systemmessage_8h_source.html#l00047">systemmessage.h:47</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html"><div class="ttname"><a href="classIMessageDispatcher.html">IMessageDispatcher</a></div><div class="ttdef"><b>Definition:</b> <a href="imessagedispatcher_8h_source.html#l00034">imessagedispatcher.h:34</a></div></div>
<div class="ttc" id="aclassChatHistory_html_af4a09d34a43139aa75808a0946c3a973"><div class="ttname"><a href="classChatHistory.html#af4a09d34a43139aa75808a0946c3a973">ChatHistory::f</a></div><div class="ttdeci">Friend &amp; f</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00069">chathistory.h:69</a></div></div>
<div class="ttc" id="aclassChatHistory_html_aa875c1b421ec3d24781b4ae95abfd159"><div class="ttname"><a href="classChatHistory.html#aa875c1b421ec3d24781b4ae95abfd159">ChatHistory::onMessageBroken</a></div><div class="ttdeci">void onMessageBroken(DispatchedMessageId id, BrokenMessageReason reason)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00312">chathistory.cpp:312</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_a4802ac590660667d9c4d73383544b38b"><div class="ttname"><a href="classIMessageDispatcher.html#a4802ac590660667d9c4d73383544b38b">IMessageDispatcher::messageSent</a></div><div class="ttdeci">void messageSent(DispatchedMessageId id, const Message &amp;message)</div><div class="ttdoc">Emitted when a message is processed and sent.</div></div>
<div class="ttc" id="aclassSessionChatLog_html_ac54787b413212bf6ff6dc7afe8aba011"><div class="ttname"><a href="classSessionChatLog.html#ac54787b413212bf6ff6dc7afe8aba011">SessionChatLog::addSystemMessage</a></div><div class="ttdeci">void addSystemMessage(const SystemMessage &amp;message) override</div><div class="ttdoc">Inserts a system message at the end of the chat.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00322">sessionchatlog.cpp:322</a></div></div>
<div class="ttc" id="astructHistory_1_1HistMessage_html_a7fe2da7726895af7865e5d4fe24c8337"><div class="ttname"><a href="structHistory_1_1HistMessage.html#a7fe2da7726895af7865e5d4fe24c8337">History::HistMessage::extensionSet</a></div><div class="ttdeci">ExtensionSet extensionSet</div><div class="ttdef"><b>Definition:</b> <a href="history_8h_source.html#l00178">history.h:178</a></div></div>
<div class="ttc" id="aclassChatHistory_html_abddd05bb13f8ae19010a847aba7581a3"><div class="ttname"><a href="classChatHistory.html#abddd05bb13f8ae19010a847aba7581a3">ChatHistory::onFileTransferBrokenUnbroken</a></div><div class="ttdeci">void onFileTransferBrokenUnbroken(const ToxPk &amp;sender, const ToxFile &amp;file, bool broken)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00260">chathistory.cpp:260</a></div></div>
<div class="ttc" id="aclassChatLogItem_html_a8f24d7341e0ae0b21fee3f9e0bae9334"><div class="ttname"><a href="classChatLogItem.html#a8f24d7341e0ae0b21fee3f9e0bae9334">ChatLogItem::getContentType</a></div><div class="ttdeci">ContentType getContentType() const</div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8cpp_source.html#l00070">chatlogitem.cpp:70</a></div></div>
<div class="ttc" id="ahistory_8h_html_a0ee552d065aa1e11e1a4d6da9a79407da54b53072540eeeb8f8e9343e71f28176"><div class="ttname"><a href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da54b53072540eeeb8f8e9343e71f28176">HistMessageContentType::system</a></div><div class="ttdeci">@ system</div></div>
<div class="ttc" id="aclassSessionChatLog_html"><div class="ttname"><a href="classSessionChatLog.html">SessionChatLog</a></div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8h_source.html#l00031">sessionchatlog.h:31</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a1fecc026256c1c85fe70413717b78614"><div class="ttname"><a href="classSessionChatLog.html#a1fecc026256c1c85fe70413717b78614">SessionChatLog::onFileTransferRemotePausedUnpaused</a></div><div class="ttdeci">void onFileTransferRemotePausedUnpaused(const ToxPk &amp;sender, const ToxFile &amp;file, bool paused)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00501">sessionchatlog.cpp:501</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a41d0356f1a51afa86316d9107592adab"><div class="ttname"><a href="classSessionChatLog.html#a41d0356f1a51afa86316d9107592adab">SessionChatLog::at</a></div><div class="ttdeci">const ChatLogItem &amp; at(ChatLogIdx idx) const override</div><div class="ttdoc">Returns reference to item at idx.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00150">sessionchatlog.cpp:150</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a26621d3829ef2381a2d253d78995f6b1"><div class="ttname"><a href="classSessionChatLog.html#a26621d3829ef2381a2d253d78995f6b1">SessionChatLog::onFileTransferBrokenUnbroken</a></div><div class="ttdeci">void onFileTransferBrokenUnbroken(const ToxPk &amp;sender, const ToxFile &amp;file, bool broken)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00507">sessionchatlog.cpp:507</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a7925da808543a5228a662b654ee6c3fd"><div class="ttname"><a href="classSessionChatLog.html#a7925da808543a5228a662b654ee6c3fd">SessionChatLog::insertBrokenMessageAtIdx</a></div><div class="ttdeci">void insertBrokenMessageAtIdx(ChatLogIdx idx, const ToxPk &amp;sender, QString senderName, const ChatLogMessage &amp;message)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00353">sessionchatlog.cpp:353</a></div></div>
<div class="ttc" id="aclassHistory_html_a211bf5d2ffa4c1657b4c5f37fcebf510"><div class="ttname"><a href="classHistory.html#a211bf5d2ffa4c1657b4c5f37fcebf510">History::addNewSystemMessage</a></div><div class="ttdeci">void addNewSystemMessage(const ToxPk &amp;friendPk, const SystemMessage &amp;systemMessage)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l00957">history.cpp:957</a></div></div>
<div class="ttc" id="aclassHistory_html_a08022c9c5a58ddd0ccc7421042ba1e0a"><div class="ttname"><a href="classHistory.html#a08022c9c5a58ddd0ccc7421042ba1e0a">History::markAsDelivered</a></div><div class="ttdeci">void markAsDelivered(RowId messageId)</div><div class="ttdoc">Marks a message as delivered. Removing message from the faux-offline pending messages list.</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01374">history.cpp:1374</a></div></div>
<div class="ttc" id="anamespaceFileTransferList_html_a349e50502ba7f13574a1822315a16c90af7bd60b75b29d79b660a2859395c1a24"><div class="ttname"><a href="namespaceFileTransferList.html#a349e50502ba7f13574a1822315a16c90af7bd60b75b29d79b660a2859395c1a24">FileTransferList::Column::size</a></div><div class="ttdeci">@ size</div></div>
<div class="ttc" id="aclassChatHistory_html_ad04eb691ef9e122b4ebc8a1a74064ed1"><div class="ttname"><a href="classChatHistory.html#ad04eb691ef9e122b4ebc8a1a74064ed1">ChatHistory::brokenMessages</a></div><div class="ttdeci">QMap&lt; DispatchedMessageId, BrokenMessageReason &gt; brokenMessages</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00080">chathistory.h:80</a></div></div>
<div class="ttc" id="achatform_8h_html"><div class="ttname"><a href="chatform_8h.html">chatform.h</a></div></div>
<div class="ttc" id="aclassHistory_html_a889a688372db3fe48bdb1dc37e8755c2"><div class="ttname"><a href="classHistory.html#a889a688372db3fe48bdb1dc37e8755c2">History::getNumMessagesForFriendBeforeDate</a></div><div class="ttdeci">size_t getNumMessagesForFriendBeforeDate(const ToxPk &amp;friendPk, const QDateTime &amp;date)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01018">history.cpp:1018</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a0004c3e58691d4e00ad53deb4da5c075"><div class="ttname"><a href="classChatHistory.html#a0004c3e58691d4e00ad53deb4da5c075">ChatHistory::dispatchedMessageRowIdMap</a></div><div class="ttdeci">QMap&lt; DispatchedMessageId, RowId &gt; dispatchedMessageRowIdMap</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00084">chathistory.h:84</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a091602a866650a2fa999eda6bacca2ad"><div class="ttname"><a href="classChatHistory.html#a091602a866650a2fa999eda6bacca2ad">ChatHistory::completedMessages</a></div><div class="ttdeci">QSet&lt; DispatchedMessageId &gt; completedMessages</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00077">chathistory.h:77</a></div></div>
<div class="ttc" id="aclassHistory_html_a3b82aa28959279e829dcd4efb4a27fa8"><div class="ttname"><a href="classHistory.html#a3b82aa28959279e829dcd4efb4a27fa8">History::getUndeliveredMessagesForFriend</a></div><div class="ttdeci">QList&lt; HistMessage &gt; getUndeliveredMessagesForFriend(const ToxPk &amp;friendPk)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01158">history.cpp:1158</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a20c9d56f2fddd8d12c6d7d98e0d4e437"><div class="ttname"><a href="classChatHistory.html#a20c9d56f2fddd8d12c6d7d98e0d4e437">ChatHistory::settings</a></div><div class="ttdeci">const Settings &amp; settings</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00071">chathistory.h:71</a></div></div>
<div class="ttc" id="ahistory_8h_html_a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3"><div class="ttname"><a href="history_8h.html#a0ee552d065aa1e11e1a4d6da9a79407da78e731027d8fd50ed642340b7c9a63b3">HistMessageContentType::message</a></div><div class="ttdeci">@ message</div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_adb7aa138db9f744ef7a3217777309653"><div class="ttname"><a href="classIMessageDispatcher.html#adb7aa138db9f744ef7a3217777309653">IMessageDispatcher::messageComplete</a></div><div class="ttdeci">void messageComplete(DispatchedMessageId id)</div><div class="ttdoc">Emitted when a receiver report is received from the associated chat.</div></div>
<div class="ttc" id="aclassSessionChatLog_html_ad759dd3e126305734a0ce86927752422"><div class="ttname"><a href="classSessionChatLog.html#ad759dd3e126305734a0ce86927752422">SessionChatLog::insertCompleteMessageAtIdx</a></div><div class="ttdeci">void insertCompleteMessageAtIdx(ChatLogIdx idx, const ToxPk &amp;sender, QString senderName, const ChatLogMessage &amp;message)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00331">sessionchatlog.cpp:331</a></div></div>
<div class="ttc" id="aclassToxPk_html"><div class="ttname"><a href="classToxPk.html">ToxPk</a></div><div class="ttdoc">This class represents a Tox Public Key, which is a part of Tox ID.</div><div class="ttdef"><b>Definition:</b> <a href="toxpk_8h_source.html#l00026">toxpk.h:26</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a344eb9def397254e0345c21e6bbf7ad4"><div class="ttname"><a href="classChatHistory.html#a344eb9def397254e0345c21e6bbf7ad4">ChatHistory::ensureIdxInSessionChatLog</a></div><div class="ttdeci">void ensureIdxInSessionChatLog(ChatLogIdx idx) const</div><div class="ttdoc">Forces the given index and all future indexes to be in the chatlog.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00328">chathistory.cpp:328</a></div></div>
<div class="ttc" id="aclassFriend_html"><div class="ttname"><a href="classFriend.html">Friend</a></div><div class="ttdef"><b>Definition:</b> <a href="friend_8h_source.html#l00031">friend.h:31</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a0aba198b4987cc18478ca8bda8aba8f5"><div class="ttname"><a href="classSessionChatLog.html#a0aba198b4987cc18478ca8bda8aba8f5">SessionChatLog::getNextIdx</a></div><div class="ttdeci">ChatLogIdx getNextIdx() const override</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00289">sessionchatlog.cpp:289</a></div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1a0bf5a3ac9b920a4cd3c591b5f20ecbdc"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1a0bf5a3ac9b920a4cd3c591b5f20ecbdc">ToxFile::INITIALIZING</a></div><div class="ttdeci">@ INITIALIZING</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00038">toxfile.h:38</a></div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1af0d36f6445e3334cb7be476f5bd815bf"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1af0d36f6445e3334cb7be476f5bd815bf">ToxFile::PAUSED</a></div><div class="ttdeci">@ PAUSED</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00039">toxfile.h:39</a></div></div>
<div class="ttc" id="astructChatLogMessage_html"><div class="ttname"><a href="structChatLogMessage.html">ChatLogMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8h_source.html#l00030">chatlogitem.h:30</a></div></div>
<div class="ttc" id="aclassHistory_html_a358d34068f7daba96c510e3236a4e004"><div class="ttname"><a href="classHistory.html#a358d34068f7daba96c510e3236a4e004">History::getNumMessagesForFriendBeforeDateBoundaries</a></div><div class="ttdeci">QList&lt; DateIdx &gt; getNumMessagesForFriendBeforeDateBoundaries(const ToxPk &amp;friendPk, const QDate &amp;from, size_t maxNum)</div><div class="ttdoc">Gets date boundaries in conversation with friendPk. History doesn't model conversation indexes,...</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01313">history.cpp:1313</a></div></div>
<div class="ttc" id="aclassICoreIdHandler_html_a15380c37fd91dabf3399783f6361a5fd"><div class="ttname"><a href="classICoreIdHandler.html#a15380c37fd91dabf3399783f6361a5fd">ICoreIdHandler::getSelfPublicKey</a></div><div class="ttdeci">virtual ToxPk getSelfPublicKey() const =0</div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1aaf48ada90ef17e0c187e8f44e6cba2d6"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1aaf48ada90ef17e0c187e8f44e6cba2d6">ToxFile::CANCELED</a></div><div class="ttdeci">@ CANCELED</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00042">toxfile.h:42</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a750f5d39ddd30b1f2a8c28dc0947d69f"><div class="ttname"><a href="classChatHistory.html#a750f5d39ddd30b1f2a8c28dc0947d69f">ChatHistory::handleDispatchedMessage</a></div><div class="ttdeci">void handleDispatchedMessage(DispatchedMessageId dispatchId, RowId historyId)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00465">chathistory.cpp:465</a></div></div>
<div class="ttc" id="aclassHistory_html_a51b715e3544228018a5a035652ae56de"><div class="ttname"><a href="classHistory.html#a51b715e3544228018a5a035652ae56de">History::getMessagesForFriend</a></div><div class="ttdeci">QList&lt; HistMessage &gt; getMessagesForFriend(const ToxPk &amp;friendPk, size_t firstIdx, size_t lastIdx)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01046">history.cpp:1046</a></div></div>
<div class="ttc" id="aimessagedispatcher_8h_html_afb201dd3f584a274572a8f0730b21a7d"><div class="ttname"><a href="imessagedispatcher_8h.html#afb201dd3f584a274572a8f0730b21a7d">DispatchedMessageId</a></div><div class="ttdeci">NamedType&lt; size_t, struct SentMessageIdTag, Orderable, Incrementable &gt; DispatchedMessageId</div><div class="ttdef"><b>Definition:</b> <a href="imessagedispatcher_8h_source.html#l00031">imessagedispatcher.h:31</a></div></div>
<div class="ttc" id="astructToxFile_html_a85ada69bf7b7f5804448dfd47c1d40a1ac04d6ce3c9d38de326215f45299a1375"><div class="ttname"><a href="structToxFile.html#a85ada69bf7b7f5804448dfd47c1d40a1ac04d6ce3c9d38de326215f45299a1375">ToxFile::FINISHED</a></div><div class="ttdeci">@ FINISHED</div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00043">toxfile.h:43</a></div></div>
<div class="ttc" id="aclassChatHistory_html_addb5c44ae1d6e70549875bcb6636d69b"><div class="ttname"><a href="classChatHistory.html#addb5c44ae1d6e70549875bcb6636d69b">ChatHistory::onMessageReceived</a></div><div class="ttdeci">void onMessageReceived(const ToxPk &amp;sender, const Message &amp;message)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00265">chathistory.cpp:265</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a190a6ea7cca8337ec5f345a681de4026"><div class="ttname"><a href="classChatHistory.html#a190a6ea7cca8337ec5f345a681de4026">ChatHistory::completeMessage</a></div><div class="ttdeci">void completeMessage(DispatchedMessageId id)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00485">chathistory.cpp:485</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a94791b3d1407d966e4a649838e07bc36"><div class="ttname"><a href="classChatHistory.html#a94791b3d1407d966e4a649838e07bc36">ChatHistory::breakMessage</a></div><div class="ttdeci">void breakMessage(DispatchedMessageId id, BrokenMessageReason reason)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00497">chathistory.cpp:497</a></div></div>
<div class="ttc" id="aclassIChatLog_html_af86b2f61da614a62e205008a5006d1be"><div class="ttname"><a href="classIChatLog.html#af86b2f61da614a62e205008a5006d1be">IChatLog::itemUpdated</a></div><div class="ttdeci">void itemUpdated(ChatLogIdx idx)</div></div>
<div class="ttc" id="astructHistory_1_1DateIdx_html"><div class="ttname"><a href="structHistory_1_1DateIdx.html">History::DateIdx</a></div><div class="ttdef"><b>Definition:</b> <a href="history_8h_source.html#l00182">history.h:182</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_adffa9a880387ea74bdacf7a4b176beb0"><div class="ttname"><a href="classSessionChatLog.html#adffa9a880387ea74bdacf7a4b176beb0">SessionChatLog::insertIncompleteMessageAtIdx</a></div><div class="ttdeci">void insertIncompleteMessageAtIdx(ChatLogIdx idx, const ToxPk &amp;sender, QString senderName, const ChatLogMessage &amp;message, DispatchedMessageId dispatchId)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00341">sessionchatlog.cpp:341</a></div></div>
<div class="ttc" id="aclassChatHistory_html_ad16fa57414547f2d14a0a7579b28bee8"><div class="ttname"><a href="classChatHistory.html#ad16fa57414547f2d14a0a7579b28bee8">ChatHistory::sessionChatLog</a></div><div class="ttdeci">SessionChatLog sessionChatLog</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00073">chathistory.h:73</a></div></div>
<div class="ttc" id="aclassFriend_html_a4e5ab2a6eb7e7ea04d2b01d73677a280"><div class="ttname"><a href="classFriend.html#a4e5ab2a6eb7e7ea04d2b01d73677a280">Friend::getDisplayedName</a></div><div class="ttdeci">QString getDisplayedName() const override</div><div class="ttdoc">Friend::getDisplayedName Gets the name that should be displayed for a user.</div><div class="ttdef"><b>Definition:</b> <a href="friend_8cpp_source.html#l00112">friend.cpp:112</a></div></div>
<div class="ttc" id="abrokenmessagereason_8h_html_a5aeb89765ee85523ed7aba8a393f0082"><div class="ttname"><a href="brokenmessagereason_8h.html#a5aeb89765ee85523ed7aba8a393f0082">BrokenMessageReason</a></div><div class="ttdeci">BrokenMessageReason</div><div class="ttdef"><b>Definition:</b> <a href="brokenmessagereason_8h_source.html#l00023">brokenmessagereason.h:23</a></div></div>
<div class="ttc" id="astructSearchPos_html_afe2cc6801fe8267916714079c4d1ff25"><div class="ttname"><a href="structSearchPos.html#afe2cc6801fe8267916714079c4d1ff25">SearchPos::numMatches</a></div><div class="ttdeci">size_t numMatches</div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00047">ichatlog.h:47</a></div></div>
<div class="ttc" id="aichatlog_8h_html_a96271e762347ce4dd132a59c19c4f59d"><div class="ttname"><a href="ichatlog_8h.html#a96271e762347ce4dd132a59c19c4f59d">ChatLogIdx</a></div><div class="ttdeci">NamedType&lt; size_t, struct ChatLogIdxTag, Orderable, UnderlyingAddable, UnitlessDifferencable, Incrementable &gt; ChatLogIdx</div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00038">ichatlog.h:38</a></div></div>
<div class="ttc" id="aclassChatLogItem_html_a3920bf552f66ac72be4b6ec8fe7947cd"><div class="ttname"><a href="classChatLogItem.html#a3920bf552f66ac72be4b6ec8fe7947cd">ChatLogItem::getContentAsMessage</a></div><div class="ttdeci">ChatLogMessage &amp; getContentAsMessage()</div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8cpp_source.html#l00087">chatlogitem.cpp:87</a></div></div>
<div class="ttc" id="aextension_8h_html_a7938c358297aa9db8ac6f400a81681aa"><div class="ttname"><a href="extension_8h.html#a7938c358297aa9db8ac6f400a81681aa">ExtensionSet</a></div><div class="ttdeci">std::bitset&lt; ExtensionType::max &gt; ExtensionSet</div><div class="ttdef"><b>Definition:</b> <a href="extension_8h_source.html#l00032">extension.h:32</a></div></div>
<div class="ttc" id="aclassHistory_html"><div class="ttname"><a href="classHistory.html">History</a></div><div class="ttdoc">Interacts with the profile database to save the chat history.</div><div class="ttdef"><b>Definition:</b> <a href="history_8h_source.html#l00135">history.h:135</a></div></div>
<div class="ttc" id="aclassHistory_html_a45e92a551ba16cee4704458c16237a97"><div class="ttname"><a href="classHistory.html#a45e92a551ba16cee4704458c16237a97">History::addNewFileMessage</a></div><div class="ttdeci">void addNewFileMessage(const ToxPk &amp;friendPk, const QString &amp;fileId, const QString &amp;fileName, const QString &amp;filePath, int64_t size, const ToxPk &amp;sender, const QDateTime &amp;time, QString const &amp;dispName)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l00915">history.cpp:915</a></div></div>
<div class="ttc" id="aclassHistory_html_ac44641454765cf9ce2c71ed1e17adccf"><div class="ttname"><a href="classHistory.html#ac44641454765cf9ce2c71ed1e17adccf">History::getNumMessagesForFriend</a></div><div class="ttdeci">size_t getNumMessagesForFriend(const ToxPk &amp;friendPk)</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01009">history.cpp:1009</a></div></div>
<div class="ttc" id="astructSearchPos_html"><div class="ttname"><a href="structSearchPos.html">SearchPos</a></div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00041">ichatlog.h:41</a></div></div>
<div class="ttc" id="aclassSettings_html_a20043d9e2168266b84dd45e90a932a6a"><div class="ttname"><a href="classSettings.html#a20043d9e2168266b84dd45e90a932a6a">Settings::getEnableLogging</a></div><div class="ttdeci">bool getEnableLogging() const</div><div class="ttdef"><b>Definition:</b> <a href="settings_8cpp_source.html#l01241">settings.cpp:1241</a></div></div>
<div class="ttc" id="aclassFriend_html_af70f411bcc1eb67da52483a63c19b01f"><div class="ttname"><a href="classFriend.html#af70f411bcc1eb67da52483a63c19b01f">Friend::getPublicKey</a></div><div class="ttdeci">const ToxPk &amp; getPublicKey() const</div><div class="ttdef"><b>Definition:</b> <a href="friend_8cpp_source.html#l00131">friend.cpp:131</a></div></div>
<div class="ttc" id="ahistory_8h_html_ad41836a9943219d559e6adece196749ead9a22d7a8178d5b42a8750123cbfe5b1"><div class="ttname"><a href="history_8h.html#ad41836a9943219d559e6adece196749ead9a22d7a8178d5b42a8750123cbfe5b1">MessageState::complete</a></div><div class="ttdeci">@ complete</div></div>
<div class="ttc" id="aclassICoreIdHandler_html"><div class="ttname"><a href="classICoreIdHandler.html">ICoreIdHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="icoreidhandler_8h_source.html#l00025">icoreidhandler.h:25</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_ac8c375d7556639b3dce5eca75cce9018"><div class="ttname"><a href="classSessionChatLog.html#ac8c375d7556639b3dce5eca75cce9018">SessionChatLog::insertSystemMessageAtIdx</a></div><div class="ttdeci">void insertSystemMessageAtIdx(ChatLogIdx idx, SystemMessage message)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00370">sessionchatlog.cpp:370</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a27a7596ee194fd68c89d34c07d8d9592"><div class="ttname"><a href="classSessionChatLog.html#a27a7596ee194fd68c89d34c07d8d9592">SessionChatLog::searchForward</a></div><div class="ttdeci">SearchResult searchForward(SearchPos startIdx, const QString &amp;phrase, const ParameterSearch &amp;parameter) const override</div><div class="ttdoc">searches forwards through the chat log until phrase is found according to parameter</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00160">sessionchatlog.cpp:160</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_a1ce8d0da816495abb00561a22a65bab8"><div class="ttname"><a href="classIMessageDispatcher.html#a1ce8d0da816495abb00561a22a65bab8">IMessageDispatcher::messageReceived</a></div><div class="ttdeci">void messageReceived(const ToxPk &amp;sender, const Message &amp;message)</div><div class="ttdoc">Emitted when a message is received and processed.</div></div>
<div class="ttc" id="aclassHistory_html_abcce3c0e31955b6bf77b8d96a62e5b29"><div class="ttname"><a href="classHistory.html#abcce3c0e31955b6bf77b8d96a62e5b29">History::addNewMessage</a></div><div class="ttdeci">void addNewMessage(const ToxPk &amp;friendPk, const QString &amp;message, const ToxPk &amp;sender, const QDateTime &amp;time, bool isDelivered, ExtensionSet extensions, QString dispName, const std::function&lt; void(RowId)&gt; &amp;insertIdCallback={})</div><div class="ttdoc">Saves a chat message in the database.</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l00977">history.cpp:977</a></div></div>
<div class="ttc" id="aclassChatHistory_html_ace6cb8a2aa79064f748153a67820904a"><div class="ttname"><a href="classChatHistory.html#ace6cb8a2aa79064f748153a67820904a">ChatHistory::coreIdHandler</a></div><div class="ttdeci">const ICoreIdHandler &amp; coreIdHandler</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8h_source.html#l00072">chathistory.h:72</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_a979682abd2375761cad6dfd4efca5693"><div class="ttname"><a href="classIMessageDispatcher.html#a979682abd2375761cad6dfd4efca5693">IMessageDispatcher::sendExtendedMessage</a></div><div class="ttdeci">virtual std::pair&lt; DispatchedMessageId, DispatchedMessageId &gt; sendExtendedMessage(const QString &amp;content, ExtensionSet extensions)=0</div><div class="ttdoc">Sends message to associated chat ensuring that extensions are available.</div></div>
<div class="ttc" id="astructMessage_html_a404a35c5ab63d17c5f83e40487751fe2"><div class="ttname"><a href="structMessage.html#a404a35c5ab63d17c5f83e40487751fe2">Message::timestamp</a></div><div class="ttdeci">QDateTime timestamp</div><div class="ttdef"><b>Definition:</b> <a href="message_8h_source.html#l00056">message.h:56</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a46049bd99919563e0b5dd16fe90f7d74"><div class="ttname"><a href="classChatHistory.html#a46049bd99919563e0b5dd16fe90f7d74">ChatHistory::onFileUpdated</a></div><div class="ttdeci">void onFileUpdated(const ToxPk &amp;sender, const ToxFile &amp;file)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00219">chathistory.cpp:219</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a4af83d592f2eaee02a8316c3393a8d52"><div class="ttname"><a href="classChatHistory.html#a4af83d592f2eaee02a8316c3393a8d52">ChatHistory::ChatHistory</a></div><div class="ttdeci">ChatHistory(Friend &amp;f_, History *history_, const ICoreIdHandler &amp;coreIdHandler, const Settings &amp;settings, IMessageDispatcher &amp;messageDispatcher)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00073">chathistory.cpp:73</a></div></div>
<div class="ttc" id="astructChatLogMessage_html_ab4a27761e501b10860a62bc05d7f2b59"><div class="ttname"><a href="structChatLogMessage.html#ab4a27761e501b10860a62bc05d7f2b59">ChatLogMessage::message</a></div><div class="ttdeci">Message message</div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8h_source.html#l00033">chatlogitem.h:33</a></div></div>
<div class="ttc" id="aclassChatForm_html_af0217fe33fb687e019f1c675a87a3931"><div class="ttname"><a href="classChatForm.html#af0217fe33fb687e019f1c675a87a3931">ChatForm::ACTION_PREFIX</a></div><div class="ttdeci">static const QString ACTION_PREFIX</div><div class="ttdef"><b>Definition:</b> <a href="chatform_8h_source.html#l00058">chatform.h:58</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a3fb366a4aa06e95f9fa72d592076934a"><div class="ttname"><a href="classChatHistory.html#a3fb366a4aa06e95f9fa72d592076934a">ChatHistory::addSystemMessage</a></div><div class="ttdeci">void addSystemMessage(const SystemMessage &amp;message) override</div><div class="ttdoc">Inserts a system message at the end of the chat.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00209">chathistory.cpp:209</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a91e922f07ec81480eff8e43b839d7617"><div class="ttname"><a href="classSessionChatLog.html#a91e922f07ec81480eff8e43b839d7617">SessionChatLog::onMessageReceived</a></div><div class="ttdeci">void onMessageReceived(const ToxPk &amp;sender, const Message &amp;message)</div><div class="ttdoc">Inserts message data into the chatlog buffer.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00381">sessionchatlog.cpp:381</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_aaafbdf70e7db74e8ed61496667e16a13"><div class="ttname"><a href="classSessionChatLog.html#aaafbdf70e7db74e8ed61496667e16a13">SessionChatLog::onMessageComplete</a></div><div class="ttdeci">void onMessageComplete(DispatchedMessageId id)</div><div class="ttdoc">Marks the associated message as complete and notifies any listeners.</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00417">sessionchatlog.cpp:417</a></div></div>
<div class="ttc" id="aclassChatHistory_html_ab2719a6a9cfa86eaa1907e4ee9d64674"><div class="ttname"><a href="classChatHistory.html#ab2719a6a9cfa86eaa1907e4ee9d64674">ChatHistory::searchForward</a></div><div class="ttdeci">SearchResult searchForward(SearchPos startIdx, const QString &amp;phrase, const ParameterSearch &amp;parameter) const override</div><div class="ttdoc">searches forwards through the chat log until phrase is found according to parameter</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00122">chathistory.cpp:122</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a088f7504cbfbe5348eba7024400cc176"><div class="ttname"><a href="classChatHistory.html#a088f7504cbfbe5348eba7024400cc176">ChatHistory::canUseHistory</a></div><div class="ttdeci">bool canUseHistory() const</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00509">chathistory.cpp:509</a></div></div>
<div class="ttc" id="astructToxFile_html"><div class="ttname"><a href="structToxFile.html">ToxFile</a></div><div class="ttdef"><b>Definition:</b> <a href="toxfile_8h_source.html#l00032">toxfile.h:32</a></div></div>
<div class="ttc" id="ahistory_8h_html_ad41836a9943219d559e6adece196749ea54ddc3c7d064822eed932015d8740336"><div class="ttname"><a href="history_8h.html#ad41836a9943219d559e6adece196749ea54ddc3c7d064822eed932015d8740336">MessageState::broken</a></div><div class="ttdeci">@ broken</div></div>
<div class="ttc" id="aclassHistory_html_ad104cfe24475f8a6ee23641d8c8fe8ac"><div class="ttname"><a href="classHistory.html#ad104cfe24475f8a6ee23641d8c8fe8ac">History::getDateWhereFindPhrase</a></div><div class="ttdeci">QDateTime getDateWhereFindPhrase(const ToxPk &amp;friendPk, const QDateTime &amp;from, QString phrase, const ParameterSearch &amp;parameter)</div><div class="ttdoc">Search phrase in chat messages.</div><div class="ttdef"><b>Definition:</b> <a href="history_8cpp_source.html#l01211">history.cpp:1211</a></div></div>
<div class="ttc" id="aclassSessionChatLog_html_a274431e7d5d7b3899403f5bcc6ab3ffe"><div class="ttname"><a href="classSessionChatLog.html#a274431e7d5d7b3899403f5bcc6ab3ffe">SessionChatLog::insertFileAtIdx</a></div><div class="ttdeci">void insertFileAtIdx(ChatLogIdx idx, const ToxPk &amp;sender, QString senderName, const ChatLogFile &amp;file)</div><div class="ttdef"><b>Definition:</b> <a href="sessionchatlog_8cpp_source.html#l00363">sessionchatlog.cpp:363</a></div></div>
<div class="ttc" id="aclassChatHistory_html_a7281d4a0fe8b2cbb4c7e973cf6550491"><div class="ttname"><a href="classChatHistory.html#a7281d4a0fe8b2cbb4c7e973cf6550491">ChatHistory::getDateIdxs</a></div><div class="ttdeci">std::vector&lt; DateChatLogIdxPair &gt; getDateIdxs(const QDate &amp;startDate, size_t maxDates) const override</div><div class="ttdoc">Gets indexes for each new date starting at startDate.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00186">chathistory.cpp:186</a></div></div>
<div class="ttc" id="astructSearchPos_html_a42bc44d531fe4da7fa9b631ca18a1ed9"><div class="ttname"><a href="structSearchPos.html#a42bc44d531fe4da7fa9b631ca18a1ed9">SearchPos::logIdx</a></div><div class="ttdeci">ChatLogIdx logIdx</div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00044">ichatlog.h:44</a></div></div>
<div class="ttc" id="aclassChatHistory_html_ab3ea46732b21c61aaaaf7147ec2e1d12"><div class="ttname"><a href="classChatHistory.html#ab3ea46732b21c61aaaaf7147ec2e1d12">ChatHistory::searchBackward</a></div><div class="ttdeci">SearchResult searchBackward(SearchPos startIdx, const QString &amp;phrase, const ParameterSearch &amp;parameter) const override</div><div class="ttdoc">searches backwards through the chat log until phrase is found according to parameter</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00138">chathistory.cpp:138</a></div></div>
<div class="ttc" id="aclassIMessageDispatcher_html_aa2019c77250918e5e634701b172187f9"><div class="ttname"><a href="classIMessageDispatcher.html#aa2019c77250918e5e634701b172187f9">IMessageDispatcher::messageBroken</a></div><div class="ttdeci">void messageBroken(DispatchedMessageId id, BrokenMessageReason reason)</div></div>
<div class="ttc" id="aclassChatHistory_html_a5e98010471983b9890f7ef673b1e1bef"><div class="ttname"><a href="classChatHistory.html#a5e98010471983b9890f7ef673b1e1bef">ChatHistory::getInitialChatLogIdx</a></div><div class="ttdeci">ChatLogIdx getInitialChatLogIdx() const</div><div class="ttdoc">Gets the initial chat log index for a sessionChatLog with 0 items loaded from history....</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00521">chathistory.cpp:521</a></div></div>
<div class="ttc" id="aclassChatHistory_html_adf4f147d415a514283964e09ef4b1231"><div class="ttname"><a href="classChatHistory.html#adf4f147d415a514283964e09ef4b1231">ChatHistory::onMessageComplete</a></div><div class="ttdeci">void onMessageComplete(DispatchedMessageId id)</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00303">chathistory.cpp:303</a></div></div>
<div class="ttc" id="astructMessage_html"><div class="ttname"><a href="structMessage.html">Message</a></div><div class="ttdef"><b>Definition:</b> <a href="message_8h_source.html#l00052">message.h:52</a></div></div>
<div class="ttc" id="astructHistory_1_1HistMessage_html"><div class="ttname"><a href="structHistory_1_1HistMessage.html">History::HistMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="history_8h_source.html#l00139">history.h:139</a></div></div>
<div class="ttc" id="astructSearchResult_html"><div class="ttname"><a href="structSearchResult.html">SearchResult</a></div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00070">ichatlog.h:70</a></div></div>
<div class="ttc" id="astructSearchResult_html_af45ce99ea066739300276269341cc906"><div class="ttname"><a href="structSearchResult.html#af45ce99ea066739300276269341cc906">SearchResult::found</a></div><div class="ttdeci">bool found</div><div class="ttdef"><b>Definition:</b> <a href="ichatlog_8h_source.html#l00072">ichatlog.h:72</a></div></div>
<div class="ttc" id="astructChatLogFile_html"><div class="ttname"><a href="structChatLogFile.html">ChatLogFile</a></div><div class="ttdef"><b>Definition:</b> <a href="chatlogitem_8h_source.html#l00036">chatlogitem.h:36</a></div></div>
<div class="ttc" id="ahistory_8h_html_ad41836a9943219d559e6adece196749ea7c6c2e5d48ab37a007cbf70d3ea25fa4"><div class="ttname"><a href="history_8h.html#ad41836a9943219d559e6adece196749ea7c6c2e5d48ab37a007cbf70d3ea25fa4">MessageState::pending</a></div><div class="ttdeci">@ pending</div></div>
<div class="ttc" id="aclassChatHistory_html_ae5e2e3220f00ee68a3394388d253e366"><div class="ttname"><a href="classChatHistory.html#ae5e2e3220f00ee68a3394388d253e366">ChatHistory::dispatchUnsentMessages</a></div><div class="ttdeci">void dispatchUnsentMessages(IMessageDispatcher &amp;messageDispatcher)</div><div class="ttdoc">Sends any unsent messages in history to the underlying message dispatcher.</div><div class="ttdef"><b>Definition:</b> <a href="chathistory_8cpp_source.html#l00426">chathistory.cpp:426</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
